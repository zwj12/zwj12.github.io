---
layout: post
title: "Async"
date: 2021-07-16 14:42:00 +0800
author: Michael
categories: CSharp
---

# 基于Task的异步编程模式（TAP）
async方法在开始时以同步方式执行,在async方法内部,await关键字对它参数执行一个异步等待,它首先检查操作是否已经完成,如果完成,就继续运行(同步方式),否则,会暂停async方法,并返回.留下一个未完成的task，一段时间后,操作完成,async方法就恢复执行.看到这句话应该就差不多能想到await为什么不会导致线程堵塞了，当碰到await时如果没有执行成功就先暂停这个方法的执行，执行方法外以下代码，等await操作完成后再执行这个方法await之后的代码；直白点的意思就是async/await就是一个让编译器把现有的代码直接生成一个带回调逻辑代码的语法糖。  
Task 类表示通常以异步方式执行的单个操作， Task 对象是基于任务的异步模式的中心组件之一。 由于 Task 对象执行的工作通常在线程池线程上异步执行，而不是在主应用程序线程上同步执行，因此可以使用 Status 属性，还可以使用 IsCanceled、IsCompleted和 IsFaulted 属性，用于确定任务的状态。 通常，lambda 表达式用于指定任务要执行的工作。

# 异常
Task中的方法一般是不会将异常抛出。

# async/await结构，异步方法名称以Async结尾
async主要作用是**标记为异步**，但不会创建异步。
1. 调用方法：该方法调用异步方法，然后在异步方法执行其任务的时候继续执行；
2. 异步方法：该方法异步执行工作，然后立刻返回到调用方法；
3. await 表达式：用于异步方法内部，指出需要异步执行的任务。一个异步方法可以包含多个 await 表达式（不存在 await 表达式的话 IDE 会发出警告）。

# 异步方法返回类型
异步方法的返回类型只能是void、Task、Task<TResult>，尽量不使用void作为返回类型，若希望异步方法返回void类型，请使用Task，异步方法名称以Async结尾。可以使用`Task<TResult>.Result`获取返回值，也可以直接使用`var = await DemoAsync();`获取返回值。

# 异步方法
使用 async 关键字可将方法、lambda 表达式或匿名方法标记为异步。用async来修饰一个方法，表明这个方法是异步的，方法内部必须含有await修饰的方法，如果方法内部没有await关键字修饰的表达式，哪怕函数被async修饰也只能算作同步方法，执行的时候也是同步执行的。

# await修饰的方法
被await修饰的只能是Task或者Task<TResule>类型，通常情况下是一个返回类型是Task/Task<TResult>的方法

# 暂停方法
1. async方法中，当执行到await时，如果没有执行成功就先暂停这个方法的执行
2. 外部调用方法如果需要获取Task<TResult>.Result返回值时，如果异步方法没有执行完，则等待该异步方法执行完再继续执行程序。

# Task创建
    //1.new方式实例化一个Task，需要通过Start方法启动
    Task task = new Task(() =>
    {
        Thread.Sleep(100);
        Console.WriteLine($"hello, task1的线程ID为{Thread.CurrentThread.ManagedThreadId}");
    });
    task.Start();

    //2.Task.Factory.StartNew(Action action)创建和启动一个Task
    Task task2 = Task.Factory.StartNew(() =>
    {
        Thread.Sleep(100);
        Console.WriteLine($"hello, task2的线程ID为{ Thread.CurrentThread.ManagedThreadId}");
    });

    //3.Task.Run(Action action)将任务放在线程池队列，返回并启动一个Task
    Task task3 = Task.Run(() =>
    {
        Thread.Sleep(100);
        Console.WriteLine($"hello, task3的线程ID为{ Thread.CurrentThread.ManagedThreadId}");
    });